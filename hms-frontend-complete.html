<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System - Complete</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover {
            background: #f0f0ff;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .module {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .module.active {
            display: block;
        }

        .module-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .module h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .module-description {
            color: #666;
            font-size: 1.1em;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input, select, textarea {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button.secondary {
            background: #48bb78;
        }

        button.secondary:hover {
            background: #38a169;
        }

        button.danger {
            background: #f56565;
        }

        button.danger:hover {
            background: #e53e3e;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert.warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #fbd38d;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge.warning {
            background: #feebc8;
            color: #744210;
        }

        .badge.danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        .ws-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ws-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .ws-indicator.connected {
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Hospital Management System</h1>
            <div class="subtitle">Complete Healthcare Management Platform</div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="showModule('emr')">üìã Medical Records</div>
            <div class="tab" onclick="showModule('billing')">üí∞ Billing</div>
            <div class="tab" onclick="showModule('inventory')">üì¶ Inventory</div>
            <div class="tab" onclick="showModule('staff')">üë• Staff</div>
            <div class="tab" onclick="showModule('beds')">üõèÔ∏è Beds</div>
            <div class="tab" onclick="showModule('analytics')">üìä Analytics</div>
        </div>

        <!-- Electronic Medical Records Module -->
        <div id="emr" class="module active">
            <div class="module-header">
                <h2>üìã Electronic Medical Records</h2>
                <p class="module-description">Complete patient medical history, diagnoses, prescriptions, and lab results management</p>
            </div>

            <div class="form-section">
                <h3>New Medical Record</h3>
                <form id="emrForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Patient ID</label>
                            <select id="emr_patient_id" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Doctor ID</label>
                            <select id="emr_doctor_id" required>
                                <option value="">Select Doctor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Chief Complaint</label>
                            <input type="text" id="emr_complaint" placeholder="Main symptoms" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Blood Pressure</label>
                            <input type="text" id="emr_bp" placeholder="120/80">
                        </div>
                        <div class="form-group">
                            <label>Temperature (¬∞F)</label>
                            <input type="number" id="emr_temp" placeholder="98.6" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Pulse Rate</label>
                            <input type="number" id="emr_pulse" placeholder="72">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Diagnosis</label>
                        <textarea id="emr_diagnosis" placeholder="Enter diagnosis" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prescription</label>
                        <textarea id="emr_prescription" placeholder="Medications and dosage" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Lab Results</label>
                        <textarea id="emr_lab_results" placeholder="Lab test results (optional)"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="emr_notes" placeholder="Additional notes (optional)"></textarea>
                    </div>
                    <button type="submit">Create Medical Record</button>
                </form>
            </div>

            <div class="data-table">
                <h3>Recent Medical Records</h3>
                <table id="emrTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Diagnosis</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Billing Module -->
        <div id="billing" class="module">
            <div class="module-header">
                <h2>üí∞ Billing & Revenue Management</h2>
                <p class="module-description">Invoice generation, payment processing, insurance claims, and revenue tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">$0</div>
                    <div class="stat-label">Total Revenue (30 days)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="collectedRevenue">$0</div>
                    <div class="stat-label">Collected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="outstandingRevenue">$0</div>
                    <div class="stat-label">Outstanding</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInvoices">0</div>
                    <div class="stat-label">Total Invoices</div>
                </div>
            </div>

            <div class="form-section">
                <h3>Create Invoice</h3>
                <form id="billingForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Patient</label>
                            <select id="billing_patient_id" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="billing_payment_method" required>
                                <option value="cash">Cash</option>
                                <option value="insurance">Insurance</option>
                                <option value="nhis">NHIS</option>
                                <option value="hmo">HMO</option>
                                <option value="credit_card">Credit Card</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>Invoice Items</h4>
                    <div id="invoiceItems">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Item Description</label>
                                <input type="text" class="item-description" placeholder="Consultation" required>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" class="item-quantity" value="1" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Price</label>
                                <input type="number" class="item-price" placeholder="50.00" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" onclick="addInvoiceItem()">+ Add Item</button>
                        <button type="submit">Generate Invoice</button>
                    </div>
                </form>
            </div>

            <div class="data-table">
                <h3>Recent Invoices</h3>
                <table id="billingTable">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Patient</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Module -->
        <div id="inventory" class="module">
            <div class="module-header">
                <h2>üì¶ Inventory Management</h2>
                <p class="module-description">Track medications, medical supplies, equipment with automatic reorder alerts</p>
            </div>

            <div id="lowStockAlert" class="alert warning" style="display:none;">
                ‚ö†Ô∏è <span id="lowStockCount">0</span> items are running low on stock!
            </div>

            <div class="form-section">
                <h3>Stock Entry</h3>
                <form id="inventoryForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item Code</label>
                            <input type="text" id="inv_item_code" placeholder="MED001" required>
                        </div>
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" id="inv_item_name" placeholder="Paracetamol" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="inv_category" required>
                                <option value="Medicine">Medicine</option>
                                <option value="Supplies">Supplies</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Consumables">Consumables</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="inv_quantity" placeholder="100" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Unit</label>
                            <input type="text" id="inv_unit" placeholder="Tablets" required>
                        </div>
                        <div class="form-group">
                            <label>Reorder Level</label>
                            <input type="number" id="inv_reorder_level" placeholder="20" min="0" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Unit Price</label>
                            <input type="number" id="inv_unit_price" placeholder="0.50" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="inv_expiry_date">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <input type="text" id="inv_supplier" placeholder="PharmaCo" required>
                        </div>
                    </div>
                    <button type="submit">Add/Update Stock</button>
                </form>
            </div>

            <div class="action-buttons">
                <button onclick="loadLowStock()">View Low Stock Items</button>
                <button onclick="loadInventory()">Refresh Inventory</button>
            </div>

            <div class="data-table">
                <h3>Current Inventory</h3>
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Reorder Level</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Staff Management Module -->
        <div id="staff" class="module">
            <div class="module-header">
                <h2>üë• Staff Management</h2>
                <p class="module-description">Staff scheduling, attendance tracking, payroll processing, and performance metrics</p>
            </div>

            <div class="form-section">
                <h3>Add Schedule</h3>
                <form id="scheduleForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Staff Member</label>
                            <select id="schedule_staff_id" required>
                                <option value="">Select Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="schedule_date" required>
                        </div>
                        <div class="form-group">
                            <label>Shift</label>
                            <select id="schedule_shift" required>
                                <option value="Morning">Morning (6 AM - 2 PM)</option>
                                <option value="Afternoon">Afternoon (2 PM - 10 PM)</option>
                                <option value="Night">Night (10 PM - 6 AM)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="time" id="schedule_start_time" required>
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="time" id="schedule_end_time" required>
                        </div>
                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" id="schedule_department" placeholder="Emergency" required>
                        </div>
                    </div>
                    <button type="submit">Add Schedule</button>
                </form>
            </div>

            <div class="action-buttons">
                <button onclick="loadSchedules()">View Schedules</button>
                <button onclick="loadPayroll()">View Payroll</button>
            </div>

            <div class="data-table">
                <h3>Staff Roster</h3>
                <table id="staffTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Shift</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Bed Management Module -->
        <div id="beds" class="module">
            <div class="module-header">
                <h2>üõèÔ∏è Bed Management</h2>
                <p class="module-description">Real-time bed availability, admissions, discharges, and ward occupancy tracking</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalBeds">0</div>
                    <div class="stat-label">Total Beds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="occupiedBeds">0</div>
                    <div class="stat-label">Occupied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="availableBeds">0</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="occupancyRate">0%</div>
                    <div class="stat-label">Occupancy Rate</div>
                </div>
            </div>

            <div class="form-section">
                <h3>New Admission</h3>
                <form id="admissionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Patient</label>
                            <select id="admission_patient_id" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Available Bed</label>
                            <select id="admission_bed_id" required>
                                <option value="">Select Bed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Doctor</label>
                            <select id="admission_doctor_id" required>
                                <option value="">Select Doctor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Diagnosis</label>
                            <input type="text" id="admission_diagnosis" placeholder="Admission diagnosis" required>
                        </div>
                        <div class="form-group">
                            <label>Expected Discharge Date</label>
                            <input type="date" id="admission_expected_discharge">
                        </div>
                    </div>
                    <button type="submit">Admit Patient</button>
                </form>
            </div>

            <div class="data-table">
                <h3>Bed Status</h3>
                <table id="bedsTable">
                    <thead>
                        <tr>
                            <th>Bed #</th>
                            <th>Ward</th>
                            <th>Room</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Patient</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Module -->
        <div id="analytics" class="module">
            <div class="module-header">
                <h2>üìä Analytics Dashboard</h2>
                <p class="module-description">Real-time metrics, occupancy trends, revenue analytics, and performance KPIs</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="analyticsOccupancy">0%</div>
                    <div class="stat-label">Bed Occupancy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsRevenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsStaff">0</div>
                    <div class="stat-label">Staff on Duty</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="analyticsAlerts">0</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
            </div>

            <div class="form-section">
                <h3>Patient Flow (Last 7 Days)</h3>
                <canvas id="patientFlowChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="action-buttons">
                <button onclick="loadDashboard()">Refresh Dashboard</button>
                <button onclick="exportReport()">Export Report</button>
            </div>

            <div class="data-table">
                <h3>Key Metrics</h3>
                <table id="metricsTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- WebSocket Status Indicator -->
    <div class="ws-status">
        <div class="ws-indicator" id="wsIndicator"></div>
        <span id="wsStatus">Connecting...</span>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage"></p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:5801';
        let ws = null;
        
        // Initialize WebSocket
        function initWebSocket() {
            ws = new WebSocket('ws://localhost:5801');
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('wsIndicator').classList.add('connected');
                document.getElementById('wsStatus').textContent = 'Connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('wsIndicator').classList.remove('connected');
                document.getElementById('wsStatus').textContent = 'Disconnected';
                setTimeout(initWebSocket, 5000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Handle real-time updates
        function handleRealtimeUpdate(data) {
            console.log('Real-time update:', data);
            
            switch(data.type) {
                case 'low_stock_alert':
                    showAlert('Low Stock Alert', `${data.data.item_name} is running low (${data.data.quantity} remaining)`);
                    loadInventory();
                    break;
                case 'patient_admitted':
                    loadBeds();
                    loadDashboard();
                    break;
                case 'invoice_created':
                    loadBilling();
                    loadRevenueSummary();
                    break;
            }
        }
        
        // Show/hide modules
        function showModule(moduleId) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected module
            document.getElementById(moduleId).classList.add('active');
            event.target.classList.add('active');
            
            // Load module data
            switch(moduleId) {
                case 'emr': loadEMR(); break;
                case 'billing': loadBilling(); loadRevenueSummary(); break;
                case 'inventory': loadInventory(); checkLowStock(); break;
                case 'staff': loadStaff(); break;
                case 'beds': loadBeds(); break;
                case 'analytics': loadDashboard(); break;
            }
        }
        
        // API Helper
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                showAlert('Error', error.message);
                throw error;
            }
        }
        
        // EMR Functions
        async function loadEMR() {
            try {
                // Load patients for dropdown
                const patients = await apiRequest('/api/patients');
                const patientSelect = document.getElementById('emr_patient_id');
                patientSelect.innerHTML = '<option value="">Select Patient</option>';
                patients.forEach(p => {
                    patientSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
                
                // Load doctors for dropdown
                const staff = await apiRequest('/api/staff');
                const doctors = staff.filter(s => s.role === 'Doctor');
                const doctorSelect = document.getElementById('emr_doctor_id');
                doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
                doctors.forEach(d => {
                    doctorSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`;
                });
                
                // Load medical records
                const records = await apiRequest('/api/medical-records');
                const tbody = document.querySelector('#emrTable tbody');
                tbody.innerHTML = '';
                
                records.forEach(record => {
                    const row = `
                        <tr>
                            <td>${new Date(record.visit_date).toLocaleDateString()}</td>
                            <td>${record.patient_name || record.patient_id}</td>
                            <td>${record.doctor_name || record.doctor_id}</td>
                            <td>${record.diagnosis}</td>
                            <td>
                                <button onclick="viewRecord(${record.id})">View</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading EMR:', error);
            }
        }
        
        // EMR Form Submit
        document.getElementById('emrForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const vital_signs = {
                blood_pressure: document.getElementById('emr_bp').value,
                temperature: document.getElementById('emr_temp').value,
                pulse: document.getElementById('emr_pulse').value
            };
            
            const data = {
                patient_id: document.getElementById('emr_patient_id').value,
                doctor_id: document.getElementById('emr_doctor_id').value,
                chief_complaint: document.getElementById('emr_complaint').value,
                diagnosis: document.getElementById('emr_diagnosis').value,
                prescription: document.getElementById('emr_prescription').value,
                lab_results: document.getElementById('emr_lab_results').value,
                vital_signs: vital_signs,
                notes: document.getElementById('emr_notes').value
            };
            
            try {
                await apiRequest('/api/medical-records', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                showAlert('Success', 'Medical record created successfully');
                e.target.reset();
                loadEMR();
            } catch (error) {
                console.error('Error creating medical record:', error);
            }
        });
        
        // Billing Functions
        async function loadBilling() {
            try {
                // Load patients for dropdown
                const patients = await apiRequest('/api/patients');
                const patientSelect = document.getElementById('billing_patient_id');
                patientSelect.innerHTML = '<option value="">Select Patient</option>';
                patients.forEach(p => {
                    patientSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
                
                // Load invoices
                const invoices = await apiRequest('/api/billing');
                const tbody = document.querySelector('#billingTable tbody');
                tbody.innerHTML = '';
                
                invoices.forEach(invoice => {
                    const statusBadge = invoice.payment_status === 'paid' 
                        ? '<span class="badge success">Paid</span>'
                        : invoice.payment_status === 'partial'
                        ? '<span class="badge warning">Partial</span>'
                        : '<span class="badge danger">Pending</span>';
                    
                    const row = `
                        <tr>
                            <td>${invoice.invoice_number}</td>
                            <td>${invoice.patient_name || invoice.patient_id}</td>
                            <td>$${parseFloat(invoice.total_amount).toFixed(2)}</td>
                            <td>$${parseFloat(invoice.paid_amount).toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="processPayment(${invoice.id})">Payment</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading billing:', error);
            }
        }
        
        async function loadRevenueSummary() {
            try {
                const summary = await apiRequest('/api/billing/revenue-summary');
                document.getElementById('totalRevenue').textContent = `$${parseFloat(summary.total_revenue || 0).toFixed(2)}`;
                document.getElementById('collectedRevenue').textContent = `$${parseFloat(summary.total_collected || 0).toFixed(2)}`;
                document.getElementById('outstandingRevenue').textContent = `$${parseFloat(summary.outstanding || 0).toFixed(2)}`;
                document.getElementById('totalInvoices').textContent = summary.total_invoices || 0;
            } catch (error) {
                console.error('Error loading revenue summary:', error);
            }
        }
        
        // Billing Form Submit
        document.getElementById('billingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const items = [];
            document.querySelectorAll('#invoiceItems .form-grid').forEach(itemRow => {
                items.push({
                    description: itemRow.querySelector('.item-description').value,
                    quantity: parseInt(itemRow.querySelector('.item-quantity').value),
                    price: parseFloat(itemRow.querySelector('.item-price').value)
                });
            });
            
            const data = {
                patient_id: document.getElementById('billing_patient_id').value,
                payment_method: document.getElementById('billing_payment_method').value,
                items: items
            };
            
            try {
                await apiRequest('/api/billing/create-invoice', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                showAlert('Success', 'Invoice created successfully');
                e.target.reset();
                loadBilling();
                loadRevenueSummary();
            } catch (error) {
                console.error('Error creating invoice:', error);
            }
        });
        
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoiceItems');
            const newItem = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Item Description</label>
                        <input type="text" class="item-description" placeholder="Item" required>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="item-quantity" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" class="item-price" placeholder="0.00" step="0.01" required>
                    </div>
                </div>
            `;
            itemsContainer.insertAdjacentHTML('beforeend', newItem);
        }
        
        // Inventory Functions
        async function loadInventory() {
            try {
                const inventory = await apiRequest('/api/inventory');
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = '';
                
                inventory.forEach(item => {
                    const stockStatus = item.quantity <= item.reorder_level 
                        ? '<span class="badge danger">Low Stock</span>'
                        : '<span class="badge success">In Stock</span>';
                    
                    const row = `
                        <tr>
                            <td>${item.item_code}</td>
                            <td>${item.item_name}</td>
                            <td>${item.category}</td>
                            <td>${item.quantity} ${item.unit}</td>
                            <td>${item.reorder_level}</td>
                            <td>${stockStatus}</td>
                            <td>
                                <button onclick="dispenseItem('${item.item_code}')">Dispense</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }
        
        async function checkLowStock() {
            try {
                const lowStock = await apiRequest('/api/inventory/low-stock');
                if (lowStock.length > 0) {
                    document.getElementById('lowStockAlert').style.display = 'block';
                    document.getElementById('lowStockCount').textContent = lowStock.length;
                } else {
                    document.getElementById('lowStockAlert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking low stock:', error);
            }
        }
        
        async function loadLowStock() {
            try {
                const lowStock = await apiRequest('/api/inventory/low-stock');
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = '';
                
                lowStock.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.item_code}</td>
                            <td>${item.item_name}</td>
                            <td>${item.category}</td>
                            <td><strong>${item.quantity}</strong> ${item.unit}</td>
                            <td>${item.reorder_level}</td>
                            <td><span class="badge danger">Low Stock</span></td>
                            <td>
                                <button onclick="reorderItem('${item.item_code}')">Reorder</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading low stock:', error);
            }
        }
        
        // Inventory Form Submit
        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                item_code: document.getElementById('inv_item_code').value,
                item_name: document.getElementById('inv_item_name').value,
                category: document.getElementById('inv_category').value,
                quantity: parseInt(document.getElementById('inv_quantity').value),
                unit: document.getElementById('inv_unit').value,
                reorder_level: parseInt(document.getElementById('inv_reorder_level').value),
                unit_price: parseFloat(document.getElementById('inv_unit_price').value),
                expiry_date: document.getElementById('inv_expiry_date').value || null,
                supplier: document.getElementById('inv_supplier').value
            };
            
            try {
                await apiRequest('/api/inventory/stock-entry', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                showAlert('Success', 'Stock updated successfully');
                e.target.reset();
                loadInventory();
                checkLowStock();
            } catch (error) {
                console.error('Error updating stock:', error);
            }
        });
        
        // Staff Functions
        async function loadStaff() {
            try {
                const staff = await apiRequest('/api/staff');
                
                // Load staff dropdown
                const staffSelect = document.getElementById('schedule_staff_id');
                staffSelect.innerHTML = '<option value="">Select Staff</option>';
                staff.forEach(s => {
                    staffSelect.innerHTML += `<option value="${s.id}">${s.name} - ${s.role}</option>`;
                });
                
                // Load staff table
                const tbody = document.querySelector('#staffTable tbody');
                tbody.innerHTML = '';
                
                staff.forEach(s => {
                    const statusBadge = s.status === 'active' 
                        ? '<span class="badge success">Active</span>'
                        : '<span class="badge warning">Inactive</span>';
                    
                    const row = `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.role}</td>
                            <td>${s.department}</td>
                            <td>${s.shift}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }
        
        async function loadSchedules() {
            try {
                const schedules = await apiRequest('/api/staff/schedules');
                const tbody = document.querySelector('#staffTable tbody');
                tbody.innerHTML = '';
                
                schedules.forEach(s => {
                    const row = `
                        <tr>
                            <td>${new Date(s.date).toLocaleDateString()}</td>
                            <td>${s.staff_name}</td>
                            <td>${s.shift}</td>
                            <td>${s.start_time} - ${s.end_time}</td>
                            <td>${s.department}</td>
                            <td><span class="badge success">Scheduled</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }
        
        async function loadPayroll() {
            try {
                const payroll = await apiRequest('/api/staff/payroll');
                const tbody = document.querySelector('#staffTable tbody');
                tbody.innerHTML = '';
                
                payroll.forEach(p => {
                    const row = `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.role}</td>
                            <td>${p.shifts_worked} shifts</td>
                            <td>$${parseFloat(p.monthly_salary).toFixed(2)}</td>
                            <td><button onclick="processPayroll('${p.id}')">Process</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading payroll:', error);
            }
        }
        
        // Schedule Form Submit
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                staff_id: document.getElementById('schedule_staff_id').value,
                date: document.getElementById('schedule_date').value,
                shift: document.getElementById('schedule_shift').value,
                start_time: document.getElementById('schedule_start_time').value,
                end_time: document.getElementById('schedule_end_time').value,
                department: document.getElementById('schedule_department').value
            };
            
            try {
                await apiRequest('/api/staff/add-schedule', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                showAlert('Success', 'Schedule added successfully');
                e.target.reset();
                loadSchedules();
            } catch (error) {
                console.error('Error adding schedule:', error);
            }
        });
        
        // Bed Management Functions
        async function loadBeds() {
            try {
                // Load patients and doctors for admission form
                const [patients, staff, beds, availableBeds] = await Promise.all([
                    apiRequest('/api/patients'),
                    apiRequest('/api/staff'),
                    apiRequest('/api/beds'),
                    apiRequest('/api/beds/available')
                ]);
                
                // Update dropdowns
                const patientSelect = document.getElementById('admission_patient_id');
                patientSelect.innerHTML = '<option value="">Select Patient</option>';
                patients.forEach(p => {
                    patientSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
                
                const doctors = staff.filter(s => s.role === 'Doctor');
                const doctorSelect = document.getElementById('admission_doctor_id');
                doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
                doctors.forEach(d => {
                    doctorSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`;
                });
                
                const bedSelect = document.getElementById('admission_bed_id');
                bedSelect.innerHTML = '<option value="">Select Bed</option>';
                availableBeds.forEach(b => {
                    bedSelect.innerHTML += `<option value="${b.id}">${b.bed_number} - ${b.ward} (${b.bed_type})</option>`;
                });
                
                // Update stats
                const totalBeds = beds.length;
                const occupiedCount = beds.filter(b => b.is_occupied).length;
                const availableCount = totalBeds - occupiedCount;
                const occupancyRate = totalBeds > 0 ? ((occupiedCount / totalBeds) * 100).toFixed(1) : 0;
                
                document.getElementById('totalBeds').textContent = totalBeds;
                document.getElementById('occupiedBeds').textContent = occupiedCount;
                document.getElementById('availableBeds').textContent = availableCount;
                document.getElementById('occupancyRate').textContent = `${occupancyRate}%`;
                
                // Update table
                const tbody = document.querySelector('#bedsTable tbody');
                tbody.innerHTML = '';
                
                beds.forEach(bed => {
                    const statusBadge = bed.is_occupied 
                        ? '<span class="badge danger">Occupied</span>'
                        : '<span class="badge success">Available</span>';
                    
                    const actions = bed.is_occupied 
                        ? `<button onclick="dischargeBed(${bed.id})">Discharge</button>`
                        : `<button onclick="admitToBed(${bed.id})">Admit</button>`;
                    
                    const row = `
                        <tr>
                            <td>${bed.bed_number}</td>
                            <td>${bed.ward}</td>
                            <td>${bed.room_number}</td>
                            <td>${bed.bed_type}</td>
                            <td>${statusBadge}</td>
                            <td>${bed.patient_name || '-'}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading beds:', error);
            }
        }
        
        // Admission Form Submit
        document.getElementById('admissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                bed_id: document.getElementById('admission_bed_id').value,
                patient_id: document.getElementById('admission_patient_id').value,
                doctor_id: document.getElementById('admission_doctor_id').value,
                diagnosis: document.getElementById('admission_diagnosis').value,
                expected_discharge: document.getElementById('admission_expected_discharge').value || null
            };
            
            try {
                await apiRequest('/api/beds/admit', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                showAlert('Success', 'Patient admitted successfully');
                e.target.reset();
                loadBeds();
            } catch (error) {
                console.error('Error admitting patient:', error);
            }
        });
        
        // Analytics Functions
        async function loadDashboard() {
            try {
                const dashboard = await apiRequest('/api/analytics/dashboard');
                
                // Update stats
                document.getElementById('analyticsOccupancy').textContent = `${dashboard.occupancy.occupancy_rate || 0}%`;
                document.getElementById('analyticsRevenue').textContent = `$${parseFloat(dashboard.revenue.total_revenue || 0).toFixed(2)}`;
                document.getElementById('analyticsStaff').textContent = dashboard.staff.staff_on_duty || 0;
                document.getElementById('analyticsAlerts').textContent = dashboard.inventory.low_stock_items || 0;
                
                // Load patient flow
                const patientFlow = await apiRequest('/api/analytics/patient-flow');
                
                // Update metrics table
                const tbody = document.querySelector('#metricsTable tbody');
                tbody.innerHTML = `
                    <tr>
                        <td>Total Beds</td>
                        <td>${dashboard.occupancy.total_beds}</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>Occupied Beds</td>
                        <td>${dashboard.occupancy.occupied_beds}</td>
                        <td>‚Üë</td>
                    </tr>
                    <tr>
                        <td>Outstanding Revenue</td>
                        <td>$${parseFloat(dashboard.revenue.outstanding_revenue || 0).toFixed(2)}</td>
                        <td>‚Üì</td>
                    </tr>
                    <tr>
                        <td>Total Invoices</td>
                        <td>${dashboard.revenue.total_invoices}</td>
                        <td>‚Üë</td>
                    </tr>
                `;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function exportReport() {
            showAlert('Export', 'Report generation initiated. This feature will be available soon.');
        }
        
        // Utility Functions
        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('alertModal').classList.remove('active');
        }
        
        async function processPayment(invoiceId) {
            const amount = prompt('Enter payment amount:');
            if (amount) {
                try {
                    await apiRequest('/api/billing/process-payment', {
                        method: 'POST',
                        body: JSON.stringify({
                            invoice_id: invoiceId,
                            amount: parseFloat(amount),
                            payment_method: 'cash'
                        })
                    });
                    
                    showAlert('Success', 'Payment processed successfully');
                    loadBilling();
                    loadRevenueSummary();
                } catch (error) {
                    console.error('Error processing payment:', error);
                }
            }
        }
        
        async function dispenseItem(itemCode) {
            const quantity = prompt('Enter quantity to dispense:');
            if (quantity) {
                try {
                    await apiRequest('/api/inventory/dispense', {
                        method: 'POST',
                        body: JSON.stringify({
                            item_code: itemCode,
                            quantity: parseInt(quantity)
                        })
                    });
                    
                    showAlert('Success', 'Item dispensed successfully');
                    loadInventory();
                    checkLowStock();
                } catch (error) {
                    console.error('Error dispensing item:', error);
                }
            }
        }
        
        async function dischargeBed(bedId) {
            if (confirm('Are you sure you want to discharge this patient?')) {
                try {
                    await apiRequest('/api/beds/discharge', {
                        method: 'POST',
                        body: JSON.stringify({
                            bed_id: bedId,
                            admission_id: 1 // In production, this would be the actual admission ID
                        })
                    });
                    
                    showAlert('Success', 'Patient discharged successfully');
                    loadBeds();
                } catch (error) {
                    console.error('Error discharging patient:', error);
                }
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            loadEMR();
        });
    </script>
</body>
</html>
